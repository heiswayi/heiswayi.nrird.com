<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js" itemscope itemtype="http://schema.org/WebPage"><link href="http://gmpg.org/xfn/11" rel="profile"><meta charset="UTF-8"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><title> Dynamically modify the content of a file using InstallShield deferred custom action · heiswayi nrird •••</title><meta name="description" content=" Provided solution shows how to use deferred custom action to do a find-and-replace of particular string in a file during installation time using InstallShiel... "/><meta name="keywords" content="problem resolution, installshield 2016, basic msi project, deferred custom action, customactiondata, find-and-replace installscript"><meta name="author" content="Heiswayi Nrird"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta property="og:type" content="article"><meta property="article:author" content="Heiswayi Nrird"><meta property="article:section" content=""><meta property="article:tag" content="problem resolution, installshield 2016, basic msi project, deferred custom action, customactiondata, find-and-replace installscript"><meta property="article:published_time" content="2018-06-05 00:00:00 +0800"><meta property="og:url" content="https://heiswayi.nrird.com/2018/dynamically-modify-content-of-file-using-installshield-deferred-custom-action"><meta property="og:title" content=" Dynamically modify the content of a file using InstallShield deferred custom action · heiswayi nrird ••• "><meta property="og:image" content="https://heiswayi.nrird.com/assets/logo.png"><meta property="og:description" content=" Provided solution shows how to use deferred custom action to do a find-and-replace of particular string in a file during installation time using InstallShiel... "><meta property="og:site_name" content="Heiswayi Nrird"><meta property="og:locale" content="en_US"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@heiswayi"><meta name="twitter:title" content=" Dynamically modify the content of a file using InstallShield deferred custom action · heiswayi nrird ••• "><meta name="twitter:description" content=" Provided solution shows how to use deferred custom action to do a find-and-replace of particular string in a file during installation time using InstallShiel... "><meta name="twitter:image:src" content="https://heiswayi.nrird.com/assets/logo.png"><meta itemprop="name" content=" Dynamically modify the content of a file using InstallShield deferred custom action · heiswayi nrird ••• "><meta itemprop="description" content=" Provided solution shows how to use deferred custom action to do a find-and-replace of particular string in a file during installation time using InstallShiel... "><meta itemprop="image" content="https://heiswayi.nrird.com/assets/logo.png"><link rel="canonical" href="https://heiswayi.nrird.com/2018/dynamically-modify-content-of-file-using-installshield-deferred-custom-action"><link rel="alternate" type="application/rss+xml" title="RSS" href="https://heiswayi.nrird.com/feed.xml"><link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo="><link rel="stylesheet" href="https://heiswayi.nrird.com/assets/css/main.css?20180603"> <script src="https://heiswayi.nrird.com/assets/js/modernizr.custom.js"></script> <!--[if lt IE 9]> <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script> <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.1.0/respond.min.js"></script> <script src="https://heiswayi.nrird.com/assets/js/rem.min.js"></script> <![endif]--> <a href="#content" class="skip">Skip to content</a><div class="wrap"><div class="masthead"> <canvas id="canvas" style="width:100%;height:100%;max-height:230px;position:absolute;z-index:1;opacity:0.5"></canvas><div class="container"><h2 class="masthead-title"> <a href="https://heiswayi.nrird.com" title="heiswayi nrird •••" class="title">heiswayi nrird <span class="dot-red">•</span><span class="dot-yellow">•</span><span class="dot-green">•</span></a> <small>Between coding and random stuffs </small></h2><div class="footer-social-links"> <a href="http://heiswayi.github.io/feed.xml" title="RSS Feed" target="_blank"><i class="fa fa-rss"></i></a> <a href="https://my.linkedin.com/in/nrird" title="LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a> <!--<a href="https://www.facebook.com/heiswayi.nrird" title="Facebook" target="_blank"><i class="fa fa-facebook"></i></a>--> <!--<a href="https://twitter.com/HeiswayiNrird" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>--> <a href="http://heiswayi.github.io/my-repos/" title="GitHub Repositories" target="_blank"><i class="fa fa-github-alt"></i></a> <a href="http://heiswayi.github.io/my-gists/" title="GitHub Gists" target="_blank"><i class="fa fa-code"></i></a> <a href="http://codepen.io/heiswayi/" title="CodePen" target="_blank"><i class="fa fa-codepen"></i></a> <a href="https://instagram.com/heiswayi.nrird/" title="Instagram" target="_blank"><i class="fa fa-instagram"></i></a> <a href="http://jsfiddle.net/user/heiswayi/" title="JSFiddle" target="_blank"><i class="fa fa-jsfiddle"></i></a></div><div class="nav"><ul class="top-menu"><li><a href="https://heiswayi.nrird.com/" title="Home"><i class="fa fa-home"></i></a><li><a href="https://heiswayi.nrird.com/about">About</a> <!--<li><a href="/resume">Resume <i class="fa fa-external-link-square"></i></a>--><li><a href="https://heiswayi.nrird.com/projects" class="bg-red"><i class="fa fa-space-shuttle" aria-hidden="true"></i> Projects</a><li><a href="https://heiswayi.nrird.com/tagged">Tags</a><li><a href="https://heiswayi.github.io/photography">Photography <i class="fa fa-external-link-square"></i></a><li><a href="https://heiswayi.nrird.com/reminder">Reminder</a></ul></div></div></div><div id="content" class="container content"><div class="post"><div class="post-top-meta"> <!--<div class="edit-this-page"><a href="https://github.com/heiswayi/heiswayi.github.io/blob/master/_posts/2018/2018-06-05-dynamically-modify-content-of-file-using-installshield-deferred-custom-action.md">Edit this page</a></div>--><div class="post-date">June 05, 2018</div><h1 class="post-title">Dynamically modify the content of a file using InstallShield deferred custom action</h1></div><h3 id="the-problem">The problem</h3><p>I have a metadata file that contains the installation path of my application and this metadata file is installed by my application installer in different location than my application files. The purpose of this metadata file is it would be used by other application to display my application info and also to know the install location of my application. The problem is that the installation path is hard-coded (default path) in that metadata file, and when the user changed the install location to a different path during the installation time, the installation path is now mismatched with the one in the metadata file. Thus, this has caused the other application cannot recognize the present of my application. My application installer is created using InstallShield 2016 Basic MSI project.<h3 id="the-solution">The solution</h3><p>To resolve this problem, I need to apply a deferred custom action. The reasons to use the deferred custom action because I need to make a change to the system and only deferred custom actions can be run in elevated context.<p><strong>1. Create New Set Property custom action (type 51)</strong><ul><li>Custom action name: <code class="highlighter-rouge">CA_PopulateCustomActionData</code><li>Property Name: <code class="highlighter-rouge">CA_UpdateMetadataFile</code><li>Property Value: <code class="highlighter-rouge">[INSTALLDIR]</code><li>Install Exec Sequence: <code class="highlighter-rouge">After ScheduleReboot</code><li>Install Exec Condition: <code class="highlighter-rouge">NOT REMOVE</code></ul><p>The purpose of this type-51 custom action is to pass other property value to <code class="highlighter-rouge">CustomActionData</code> property since the deferred custom actions can only access to these built-in Windows Installer properties; <code class="highlighter-rouge">CustomActionData</code>, <code class="highlighter-rouge">ProductCode</code> and <code class="highlighter-rouge">UserSID</code>. That is the limitations of the deferred custom actions.<p><strong>2. Create New InstallScript custom action as a deferred custom action</strong><ul><li>Custom action name: <code class="highlighter-rouge">CA_UpdateMetadataFile</code><li>Function Name: <code class="highlighter-rouge">MODIFY_METADATA</code><li>In-Script Execution: <code class="highlighter-rouge">Deferred Execution</code><li>Install Exec Sequence: <code class="highlighter-rouge">After CA_PopulateCustomActionData</code><li>Install Exec Condition: <code class="highlighter-rouge">NOT REMOVE</code></ul><p>Below are the InstallScript that I used to associate with my deferred custom action above in my <code class="highlighter-rouge">Setup.rul</code>.<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="n">include</span> <span class="s">"ifx.h"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"isrt.h"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"iswi.h"</span>

<span class="n">prototype</span> <span class="nf">FindAndReplace</span><span class="p">(</span><span class="n">STRING</span><span class="p">,</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">STRING</span><span class="p">);</span>

<span class="c1">//Global Variables</span>
<span class="n">STRING</span> <span class="n">SrcDirFileName</span><span class="p">,</span> <span class="n">SrchString</span><span class="p">,</span> <span class="n">RplcString</span><span class="p">;</span>
<span class="n">STRING</span> <span class="n">firstPart</span><span class="p">;</span>
<span class="n">NUMBER</span> <span class="n">SrchLen</span><span class="p">,</span> <span class="n">nvLineNumber</span><span class="p">;</span>

<span class="n">function</span> <span class="nf">FindAndReplace</span><span class="p">(</span><span class="n">SrcDirFileName</span><span class="p">,</span> <span class="n">SrchString</span><span class="p">,</span> <span class="n">RplcString</span><span class="p">)</span>
	<span class="n">STRING</span> <span class="n">svReturnLine</span><span class="p">,</span><span class="n">szString</span><span class="p">,</span> <span class="n">secPart</span><span class="p">;</span>
	<span class="n">NUMBER</span> <span class="n">nReturn</span><span class="p">,</span> <span class="n">subPos</span><span class="p">;</span>
<span class="n">begin</span>
	<span class="nf">Disable</span><span class="p">(</span><span class="n">STATUSEX</span><span class="p">);</span> <span class="c1">//stop displaying the progress bar</span>
    <span class="nf">ShowObjWizardPages</span><span class="p">(</span><span class="n">NEXT</span><span class="p">);</span> <span class="c1">//WARNING this may throw a user interface</span>
    <span class="n">SrchLen</span> <span class="p">=</span> <span class="nf">StrLength</span><span class="p">(</span><span class="n">SrchString</span><span class="p">);</span> <span class="c1">//length of search string</span>
    <span class="n">nvLineNumber</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="c1">//pre-set file line number to 0</span>
    
    <span class="n">Din</span><span class="p">:</span> 
		<span class="k">while</span> <span class="p">(</span><span class="nf">FileGrep</span> <span class="p">(</span><span class="n">SrcDirFileName</span><span class="p">,</span> <span class="n">SrchString</span><span class="p">,</span> <span class="n">svReturnLine</span><span class="p">,</span> <span class="n">nvLineNumber</span><span class="p">,</span> <span class="n">RESTART</span><span class="p">)=</span><span class="m">0</span><span class="p">)</span>
			<span class="c1">//subPos is the number where the first char of search string was found</span>
			<span class="n">subPos</span>	<span class="p">=</span> <span class="nf">StrFind</span><span class="p">(</span><span class="n">svReturnLine</span><span class="p">,</span> <span class="n">SrchString</span><span class="p">);</span>
			<span class="c1">//firstPart is the string upto search string but not including searchString</span>
			<span class="nf">StrSub</span> <span class="p">(</span><span class="n">firstPart</span><span class="p">,</span> <span class="n">svReturnLine</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">subPos</span><span class="p">);</span>
			<span class="c1">//secPart is the string after search string</span>
			<span class="nf">StrSub</span> <span class="p">(</span><span class="n">secPart</span><span class="p">,</span> <span class="n">svReturnLine</span><span class="p">,</span> <span class="n">subPos</span><span class="p">+</span><span class="n">SrchLen</span><span class="p">,</span> <span class="m">50</span><span class="p">);</span>
			<span class="c1">//new string is firstPart followed by replace string followed by secPart</span>
			<span class="n">TextSub</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span> <span class="s">"SUBBED"</span> <span class="p">)</span> <span class="p">=</span> <span class="n">RplcString</span><span class="p">;</span>
			<span class="n">szString</span> <span class="p">=</span> <span class="n">firstPart</span><span class="p">+</span><span class="s">"&lt;SUBBED&gt;"</span><span class="p">+</span><span class="n">secPart</span><span class="p">;</span>
			<span class="n">TextSub</span><span class="p">.</span><span class="nf">Substitute</span><span class="p">(</span> <span class="n">szString</span> <span class="p">);</span>
			<span class="c1">//write line replacing original  </span>
			<span class="nf">FileInsertLine</span> <span class="p">(</span><span class="n">SrcDirFileName</span><span class="p">,</span> <span class="n">szString</span><span class="p">,</span> <span class="n">nvLineNumber</span><span class="p">,</span> <span class="n">REPLACE</span><span class="p">);</span>
			<span class="c1">//the code below examines the line written back for any other occurences</span>
			<span class="c1">//systematically searching and re-writting back to file</span>
			<span class="c1">//search first line again for search string</span>
			<span class="k">if</span> <span class="p">(</span><span class="nf">FileGrep</span> <span class="p">(</span><span class="n">SrcDirFileName</span><span class="p">,</span> <span class="n">SrchString</span><span class="p">,</span> <span class="n">svReturnLine</span><span class="p">,</span> <span class="n">nvLineNumber</span><span class="p">,</span> <span class="n">RESTART</span><span class="p">)=</span><span class="m">0</span><span class="p">)</span> <span class="n">then</span>
				<span class="k">goto</span> <span class="n">Din</span><span class="p">;</span>  <span class="c1">//another occurence found</span>
			<span class="k">else</span>
				<span class="c1">//increment line number and start all over again</span>
				<span class="n">nvLineNumber</span> <span class="p">=</span> <span class="n">nvLineNumber</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
			<span class="n">endif</span><span class="p">;</span>
		<span class="n">endwhile</span><span class="p">;</span>  <span class="c1">//while loop exited when END_OF_FILE reached  </span>
<span class="n">end</span><span class="p">;</span>

<span class="n">export</span> <span class="n">prototype</span> <span class="nf">MODIFY_METADATA</span><span class="p">(</span><span class="n">HWND</span><span class="p">);</span>
<span class="n">function</span> <span class="nf">MODIFY_METADATA</span><span class="p">(</span><span class="n">hMSI</span><span class="p">)</span>
	<span class="n">STRING</span> <span class="n">installDirPath</span><span class="p">;</span>
	<span class="n">NUMBER</span> <span class="n">installDirPathBuffer</span><span class="p">;</span>
<span class="n">begin</span>
	<span class="n">installDirPathBuffer</span> <span class="p">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nf">MsiGetProperty</span><span class="p">(</span><span class="n">hMSI</span><span class="p">,</span> <span class="s">"CustomActionData"</span><span class="p">,</span> <span class="n">installDirPath</span><span class="p">,</span> <span class="n">installDirPathBuffer</span><span class="p">)</span> <span class="p">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="n">then</span>
		<span class="nf">StrReplace</span><span class="p">(</span><span class="n">installDirPath</span><span class="p">,</span><span class="s">"\\"</span><span class="p">,</span><span class="s">"\\\\"</span><span class="p">,</span><span class="m">0</span><span class="p">);</span>
	<span class="n">endif</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYSINFO</span><span class="p">.</span><span class="n">bIsWow64</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="n">then</span>
		<span class="k">if</span> <span class="nf">Is</span><span class="p">(</span><span class="n">FILE_EXISTS</span><span class="p">,</span> <span class="s">"&lt;PATH_TO_METADATA_FILE&gt;"</span><span class="p">)</span> <span class="p">=</span> <span class="n">TRUE</span> <span class="n">then</span>
			<span class="nf">FindAndReplace</span><span class="p">(</span><span class="s">"&lt;PATH_TO_METADATA_FILE&gt;"</span><span class="p">,</span><span class="s">"&lt;STRING_TO_FIND&gt;"</span><span class="p">,</span> <span class="n">installDirPath</span><span class="p">);</span>
		<span class="n">endif</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="nf">Is</span><span class="p">(</span><span class="n">FILE_EXISTS</span><span class="p">,</span> <span class="s">"&lt;PATH_TO_METADATA_FILE&gt;"</span><span class="p">)</span> <span class="p">=</span> <span class="n">TRUE</span> <span class="n">then</span>
			<span class="nf">FindAndReplace</span><span class="p">(</span><span class="s">"&lt;PATH_TO_METADATA_FILE&gt;"</span><span class="p">,</span><span class="s">"&lt;STRING_TO_FIND&gt;"</span><span class="p">,</span> <span class="n">installDirPath</span><span class="p">);</span>
		<span class="n">endif</span><span class="p">;</span>
	<span class="n">endif</span><span class="p">;</span>
<span class="n">end</span><span class="p">;</span>
</code></pre></div></div><p>Hopefully this would help others who lost.<div class="tagged"> <a href="https://heiswayi.nrird.com/tagged#installshield"><i class="fa fa-hashtag muted" aria-hidden="true"></i>InstallShield</a> <a href="https://heiswayi.nrird.com/tagged#basic-msi"><i class="fa fa-hashtag muted" aria-hidden="true"></i>Basic MSI</a> <a href="https://heiswayi.nrird.com/tagged#installscript"><i class="fa fa-hashtag muted" aria-hidden="true"></i>InstallScript</a></div><div id="disqus" style="margin-top:2em"><div id="disqus_thread"></div><script> var disqus_config = function() { this.page.url = "https://heiswayi.nrird.com/2018/dynamically-modify-content-of-file-using-installshield-deferred-custom-action"; this.page.identifier = "/2018/dynamically-modify-content-of-file-using-installshield-deferred-custom-action"; }; (function() { var d = document, s = d.createElement('script'); s.src = '//hnbloggithub.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><div class="footer"><div class="copyright"><i class="fa fa-copyright"></i> 2015 - 2018 Heiswayi Nrird // <a href="https://heiswayi.nrird.com/cookie-policy">Cookie Policy</a> // <a href="https://heiswayi.github.io/feed.xml">RSS</a></div></div><script> // Line numbering for code block (function() { var pre = document.getElementsByTagName('pre'), pl = pre.length; for (var i = 0; i < pl; i++) { pre[i].innerHTML = '<span class="line-number"></span>' + pre[i].innerHTML + '<span class="cl"></span>'; var num = pre[i].innerHTML.split(/\n/).length; for (var j = 0; j < (num - 1); j++) { var line_num = pre[i].getElementsByTagName('span')[0]; line_num.innerHTML += '<span>' + (j + 1) + '</span>'; } } })(); </script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-58296043-7', 'auto'); ga('send', 'pageview'); </script>
